<html>
<head>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
	  <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
</head>

<body>
<style>
body {
  <!--background-color: #00b894;-->
  margin: 0;
  padding: 0;
}


.wholepicture {
	width:800px;
	margin: auto;
	<!--border: 3px solid green;-->
}
.network
{
width:500px;
  position: relative;
  top: 0;
  left: 0;
}
.fan
{
	position: absolute;
	top: 20px;
	left: 226px;	
}
.arrow1, .arrow2, .arrow3, .arrow4 {
	height:60px;
	width:20px;
	position: absolute;
	top: 160px;
}

/*.counter {
	width:60px;
}*/

.form-inline , .horizontal{
  display: flex;
  flex-flow: row wrap;
  align-items: center;
}

.form-inline input{
  vertical-align: middle;
  background-color: #fff;
  border: 1px solid #ddd;
/*  margin: 0px 0px 0px 0;
  padding: 0px;
  background-color: #fff;
  border: 1px solid #ddd;*/
}
.ph{
  margin: 0px 80px 0px 0;
  padding: 0px;
}
.phstand{
  margin: 0px 130px 1px 0px;
  padding: 5px;
}
.flowstand{
	margin-top:0px;
	position:relative;
	left: 25px;
	}

</style>

<div class="wholepicture" style="position: relative; left: 0; top: 0;">

<div class="networkdiv">
<!--<img src="network_alone_plain.svg" width="500" class="network"/>-->
</div>
<img src="fan2.svg" class="fan" width="48"/>

<form class="form-inline">
</form>

<div class="horizontal">
</div>


<div>
<h2 id="totalFlow">Total flow rate: 150 m³/h</h2>
</div>
<div>
<h2 id="dp">Acutal pressure drop: 20 Pa</h2>
</div>
<div>
<h2 id="power">Electric power: 0 W</h2>
</div>


</div>



<!--<div class="icon">
  <div class="arrow"></div>  
</div>
-->

<!--
<div class="icon2">
<img id="network" src = "network_alone_plain.svg" alt="Network"/>
</div>
-->



<script>
//const $icon = document.querySelector('.icon');
//const $arrow = document.querySelector('.arrow');

const $fan = document.querySelector('.fan');
const $icon2 = document.querySelector('.wholepicture');

const $arrow1 = document.querySelector('.arrow1')
const $arrow2 = document.querySelector('.arrow2')
const $arrow3 = document.querySelector('.arrow3')
const $arrow4 = document.querySelector('.arrow4')


const $network = document.querySelector('.network');

var animations= {};

/*$fan.onclick = () => {
  
  
   animations['fan']=$fan.animate(
	{ 
	transform: 'rotate(360deg)',
	  }
  ,{
    duration: 6000,
    iterations: Infinity
  });
  
  var i=1
  for ( let ar of [$arrow1,$arrow2,$arrow3,$arrow4]){
   animations['arrow'+i]=ar.animate(
	{ 
		top: [160,220],
		rotate: ["0deg","0deg"]
	}
	,{
		duration: 1000,
		iterations: Infinity
		});
	i+=1;
	}
}*/

let initPyodide = loadPyodide()

async function main(n){
		let pyodide = await initPyodide
		await pyodide.loadPackage("numpy");
		
		window.nvents = n;
		
		pyodide.runPython(`

import numpy as np
from js import nvents


class network:
    
    def __init__(self):

        self.nVents = nvents
		

        Qmes = np.ones(nvents)*25+10*np.random.random(nvents)
        Qmes = Qmes * 200/np.sum(Qmes)
        
        self.vents = [vent() for i in range(nvents)]    
        self.Qtot = np.sum(Qmes)
     
	 
        dpmes = 30
        
        
        dpvents = self.getVentsK()*Qmes**2
        
        self.Knetwork = (dpmes-dpvents)/Qmes**2 # remove vent pressure drop in network K calc


        self.update()

    def update(self):

        totalK = self.Knetwork + self.getVentsK()

        self.actualFlows = self.solveNonLinear(totalK, self.Qtot, np.ones(self.nVents)*self.Qtot/self.nVents)

    def getFlows(self):
        return list(self.actualFlows)

    def getPressureDrop(self):
        totalK = self.Knetwork + self.getVentsK()
        return np.mean(totalK*self.actualFlows**2)

    def checkDP(self):
        
        totalK = self.Knetwork + self.getVentsK()
        dp = totalK*self.actualFlows**2
        print('Calculated pressure drops',dp)

    def printState(self):
        
        print(self.actualFlows)
        print("Branch pressure drop",self.Knetwork*self.actualFlows**2)
        print("Vents pressure drop",self.getVentsK()*self.actualFlows**2)
        print(self.getVentsK())
        print(self.actualFlows)
		

    def setVentPosition(self,ventNummer,position):
        
        self.vents[ventNummer].setPosition(position)


    def getVentsK(self):
        
        return [v.getK() for v in self.vents]


    def solveNonLinear(self,K,Qtot,Q0,relax=0.3):
        
        Qprev=Q0
        
        Qnew = self.solveLinear(K,Qtot,Qprev)
    
        res = np.sum((Qprev-Qnew)**2)
    
        nit=0    
    
        while res>.01:
            Qprev = Qprev*(1-relax)+Qnew*relax
            Qnew = self.solveLinear(K,Qtot,Qprev)
            
            res = np.sum((Qprev-Qnew)**2)
            
            nit+=1
            if nit>100:
                print('More than 100 iterations, leaving non linear loop')
                return 'Error'
    
        return Qnew
    
    def solveLinear(self,K,Qtot,Qprev):
    
        
        nFlows = len(Qprev)
        #building matrix
        
        A = np.zeros(nFlows**2).reshape(nFlows,nFlows)
        b = np.zeros(nFlows)
        
        
        for i in range(nFlows-1):
            
            A[i,i]=K[i]*Qprev[i]
            A[i,i+1] = -K[i+1]*Qprev[i+1]
        
        """for i in range(nFlows):
            A[nFlows-1,0]=1
            A[nFlows-1,1]=1
            A[nFlows-1,2]=1
            A[nFlows-1,3]=1
            b[nFlows-1] = Qtot
		"""
        for i in range(nFlows):
            A[nFlows-1,i]=1

        b[nFlows-1] = Qtot
		
        x=np.linalg.solve(A,b)
    
        return x



class vent:
    
    def __init__(self):
        reflow = 25
    
        positions = [1,2,3,4,5,6,7,8,15,18]
    
        pressuredrop = np.array([50,37,25,15,11,9,7,4,3,2])
    
    
        kreglage = pressuredrop/reflow**2
        
        
        
        #self.df = pd.DataFrame(index=positions)
        #self.df['k'] = kreglage
        
        self.kValues= kreglage
        self.positions = positions
        self.currentPosition = 18


    def checkPosition(self,position):
        
        if position<self.positions[0] or position>self.positions[-1]:
            
            print('Wrong position ',position)
            print('Positons must be between ',self.positions[0],'and',self.positions[-1])
            print('Values have been saturated')
            return


    def setPosition(self,position):

        self.checkPosition(position)        
        self.currentPosition = position

    def getK(self):
    
        return np.interp(self.currentPosition,self.positions,self.kValues)

n = network()    

n.printState()
n.checkDP()    


`);      

update(n)

		
}

function updateDisplay(flows,pressuredrop,stands){
	
	console.log(flows);
	
	for (let i=0;i<flows.length;i++){
	
		document.getElementById("flow"+(i+1)+"display").innerHTML=flows[i].toFixed(1)+" m3/h"
		//document.getElementById("flow"+(i+1)+"stand").innerHTML=stands[i]

	}


	var totalFlow = flows.reduce((partialSum, a) => partialSum + a, 0)

	document.getElementById("totalFlow").innerHTML="Total flow rate: "+totalFlow.toFixed(0)+" m³/h";

	document.getElementById("dp").innerHTML="Actual pressure drop: "+pressuredrop+" Pa";

	var power =  totalFlow * pressuredrop/3600;

	document.getElementById("power").innerHTML="Electric power: "+power.toFixed(1)+" W";


	//updateVelocity(flows)
	
}

function updateVelocity(flows){

	ref=25;
	
	for(let i = 0; i < flows.length; i++){ 

		key='arrow'+(i+1).toString();
			
		elem = document.getElementsByClassName(key)[0];
	
		style = window.getComputedStyle(elem);
	
		currentLeft = parseFloat(style.left,10);
		currentWidth = parseFloat(style.width,10);
		currentHeight = parseFloat(style.height,10);
	
	
		currentCenter = currentLeft + currentWidth/2.;
		newWidth = flows[i]/ref*20
	
		elem.style.width= newWidth+"px";
		elem.style.height="60px";
		
		newLeft = currentCenter - newWidth/2.;
		elem.style.left = newLeft+"px";
		
	}

}


async function update(n){

window.nVents = n;
test =[];

console.log("in update");
console.log(n);

for (let i=0; i<n ; i++){
	console.log(i+1);
	console.log(document.getElementById("flow"+(i+1)+"input").value);
	test.push(document.getElementById("flow"+(i+1)+"input").value);
}

window.stands = test;


//var stands = [window.v1,window.v2,window.v3,window.v4]

let pyodide = await initPyodide;
/*pyodide.toPy(v1);*/

pyodide.runPython(`

from js import stands
from js import nvents

stands = stands.to_py()

for i in range(nvents):
	n.setVentPosition(i, float(stands[i]))    
	
n.update()
flows = n.getFlows()
dp = n.getPressureDrop()
`
);

jsFlows = pyodide.globals.get("flows").toJs();
pressureDrop = pyodide.globals.get("dp").toFixed(1);
updateDisplay(jsFlows,pressureDrop,stands);

}


function drawNetwork(n){

	var margin = 10
	var WD = 60;

	if (n<=7){
		var pictureWidth = 500;
		}
	else{
		var pictureWidth = n*(WD+20)+2*margin;
		console.log(pictureWidth)
	}

	var WT = pictureWidth-2*margin;
	var DELTA = (WT - n*WD)/(n-1); 

	var H1=100;
	var H2=H1+WD;
	var H3=H2+2*WD;
	
	
	H3p = H3-H2

	svgString="M "+margin+" "+(H3+margin)
	
	svgString+="v -"+H2+" h "+(WT-WD)/2+" v -"+ H3p +" h "+WD+" v "+H3p+" h "+(WT-WD)/2+" v "+H2

	for (let i=0;i<n-1;i++){
		svgString += " h -"+WD
		svgString += " v -"+H1
		svgString += " h -"+DELTA
		svgString += " v "+H1
	}
	svgString += "Z"

	//svgString+="v "+H2+" h "+WT+" v -"+H2

	var draw = SVG().addTo('.networkdiv').size(pictureWidth, 300)
	draw.addClass('network-svg')
	var path = draw.path(svgString)

	path.fill('none').stroke({width:4, color: 'black'})

}

function drawArrow(xcenter,ypos){
	
	var margin=0;
	var W = 10;
	var L = 45 ;

	xpos = xcenter - W-margin
	
	svgString="M "+(margin+W/2+xpos)+" "+(margin+ypos);
	svgString += " h "+W;
	svgString += " v "+L;
	svgString += " h "+1/2*W;
	svgString += " l -"+W+" "+L/4;
	svgString += " l -"+W+" -"+L/4;
	svgString += " h "+1/2*W;
	svgString += " z";
	
	draw = SVG.find('.network-svg');
	
	var path = draw.path(svgString)

	path.fill({color:'#008080'}).stroke({width:1, color: 'black'})
	
}

function drawNetworkArrows(n){

	margin=10
	WD = 60
	if (n<=7){
		var pictureWidth = 500;
	}
	else{
		var pictureWidth = n*(WD+20)+2*margin;
	}
	var WT = pictureWidth-2*margin;
	var DELTA = (WT - n*WD)/(n-1); 

	
	for (let i=0;i<n;i++){
		
		xcenter = margin + WD/2 + i*(WD+DELTA)
		console.log(xcenter)
		
		drawArrow(xcenter,210)
	}
}

function createInput(number,marginRight,totalNumberOfVents){

	inputForm = document.getElementsByClassName('form-inline')[0]
	console.log(inputForm)

	var inputElement = document.createElement('input');
	inputElement.id = 'flow'+number+'input';

    inputElement.type = 'range';
    inputElement.className = 'counter';
	
	inputElement.style = "width:60px;margin-right:"+marginRight+"px";
	inputForm.appendChild(inputElement);
	inputElement.setAttribute("value", "18");
	inputElement.setAttribute("min", "1");
	inputElement.setAttribute("max", "18");

	inputElement.onchange = function(){update(totalNumberOfVents);};

}

function createFlowDisplay(number,width){

	horizontal = document.getElementsByClassName('horizontal')[0];
	var inputElement = document.createElement('p');

	inputElement.id = 'flow'+number+'display';
	horizontal.appendChild(inputElement);


	inputElement.style = "width:"+width+"px"
	
	inputElement.innerHTML  = "0 m³/h";
	
}


function createNetWorkInputs(n,WD){

	for (let i=0;i<n;i++){

		createInput(i+1,WD,n);
		createFlowDisplay(i+1,60);
	}
}


var n = 5;

drawNetwork(n)
drawNetworkArrows(n)
createNetWorkInputs(n,25)
main(n)



</script>
</body>
</html>
