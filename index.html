<html>
<head>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
</head>

<body>
<style>
body {
  <!--background-color: #00b894;-->
  margin: 0;
  padding: 0;
}

form  { display: table;      }
p     { display: table-row;  }
label { display: table-cell; }
input { display: table-cell; }

.wholepicture {
	width:800px;
	margin: auto;
	<!--border: 3px solid green;-->
}
.network
{
width:500px;
  position: relative;
  top: 0;
  left: 0;
}
.fan
{
	position: absolute;
	top: 20px;
	left: 226px;	
}
.arrow1, .arrow2, .arrow3, .arrow4 {
	height:60px;
	width:20px;
	position: absolute;
	top: 160px;
}

/*.counter {
	width:60px;
}*/

.form-inline , .horizontal{
  display: flex;
  flex-flow: row wrap;
  align-items: center;
}

.form-inline input{
  vertical-align: middle;
  background-color: #fff;
  border: 1px solid #ddd;
/*  margin: 0px 0px 0px 0;
  padding: 0px;
  background-color: #fff;
  border: 1px solid #ddd;*/
}
.ph{
  margin: 0px 80px 0px 0;
  padding: 0px;
}
.phstand{
  margin: 0px 130px 1px 0px;
  padding: 5px;
}
.flowstand{
	margin-top:0px;
	position:relative;
	left: 25px;
	}

</style>

<h1>Ventilation flow rate adjustment</h1>

<div class="inputdata">
<h2>Please fill inputs</h2>
 <form>
	<p>
		<label for="numberofvents">Number of vents:</label>
		<input type="number" id="numberofvents" name="quantity" min="2" value="5" max="8" onchange="initialize(this.valueAsNumber)">
	</p>
	<p>
		<label for="lname">Total flow rate:</label>
		<input type="number" id="totalflow" name="totalflow" min="50" value="200" max="500" onchange="changeFlow(this.valueAsNumber)">
	</p>
</form> 
</div>

<div class="instructions">
<h2>Instructions</h2>
Try to set the different vents to have an equal flow on each branch
</div>


<div class="wholepicture" style="position: relative; left: 0; top: 0;">

<div class="networkdiv">
<!--<img src="network_alone_plain.svg" width="500" class="network"/>-->
</div>
<img src="fan2.svg" class="fan" width="48"/>

<form class="form-inline">
</form>

<div class="horizontal">
</div>


<div>
<h2 id="totalFlow">Total flow rate: 150 m³/h</h2>
</div>
<div>
<h2 id="dp">Acutal pressure drop: 20 Pa</h2>
</div>
<div>
<h2 id="power">Electric power: 0 W</h2>
</div>


</div>



<!--<div class="icon">
  <div class="arrow"></div>  
</div>
-->

<!--
<div class="icon2">
<img id="network" src = "network_alone_plain.svg" alt="Network"/>
</div>
-->



<script>
//const $icon = document.querySelector('.icon');
//const $arrow = document.querySelector('.arrow');

function deleteClassElements(className){
	var paras = document.getElementsByClassName(className);
	while(paras[0]) {
		paras[0].parentNode.removeChild(paras[0]);
	}
}


const $fan = document.querySelector('.fan');
const $icon2 = document.querySelector('.wholepicture');

const $arrow1 = document.querySelector('.arrow1')
const $arrow2 = document.querySelector('.arrow2')
const $arrow3 = document.querySelector('.arrow3')
const $arrow4 = document.querySelector('.arrow4')


const $network = document.querySelector('.network');

var animations= {};

/*$fan.onclick = () => {
  
  
   animations['fan']=$fan.animate(
	{ 
	transform: 'rotate(360deg)',
	  }
  ,{
    duration: 6000,
    iterations: Infinity
  });
  
  var i=1
  for ( let ar of [$arrow1,$arrow2,$arrow3,$arrow4]){
   animations['arrow'+i]=ar.animate(
	{ 
		top: [160,220],
		rotate: ["0deg","0deg"]
	}
	,{
		duration: 1000,
		iterations: Infinity
		});
	i+=1;
	}
}*/

let initPyodide = loadPyodide()


async function loadPythonClasses(){
	let pyodide = await initPyodide
	await pyodide.loadPackage("numpy");

	pyodide.runPython(await (await fetch('https://raw.githubusercontent.com/sebbypy/ventilation-flow-tuning/main/ventilationNetwork.py')).text());
}

async function main(n){
	let pyodide = await initPyodide
	await pyodide.loadPackage("numpy");
	await loadPythonClasses();
		
	window.nvents = n;
		
	pyodide.runPython(`

import numpy as np
from js import nvents

n = network(nvents)    

`);      

update(n)

		
}

function updateDisplay(flows,pressuredrop,stands){
	
	for (let i=0;i<flows.length;i++){
		document.getElementById("flow"+(i+1)+"display").innerHTML=flows[i].toFixed(1)+" m3/h"
	}

	var totalFlow = flows.reduce((partialSum, a) => partialSum + a, 0)

	document.getElementById("totalFlow").innerHTML="Total flow rate: "+totalFlow.toFixed(0)+" m³/h";

	document.getElementById("dp").innerHTML="Actual pressure drop: "+pressuredrop+" Pa";

	var power =  totalFlow * pressuredrop/3600;

	document.getElementById("power").innerHTML="Electric power: "+power.toFixed(1)+" W";


	//updateVelocity(flows)
	
}

function updateVelocity(flows){

	ref=25;
	
	for(let i = 0; i < flows.length; i++){ 

		key='arrow'+(i+1).toString();
			
		elem = document.getElementsByClassName(key)[0];
	
		style = window.getComputedStyle(elem);
	
		currentLeft = parseFloat(style.left,10);
		currentWidth = parseFloat(style.width,10);
		currentHeight = parseFloat(style.height,10);
	
	
		currentCenter = currentLeft + currentWidth/2.;
		newWidth = flows[i]/ref*20
	
		elem.style.width= newWidth+"px";
		elem.style.height="60px";
		
		newLeft = currentCenter - newWidth/2.;
		elem.style.left = newLeft+"px";
		
	}

}


async function update(n){

window.nVents = n;
test =[];

for (let i=0; i<n ; i++){
	test.push(document.getElementById("flow"+(i+1)+"input").value);
}

window.stands = test;


let pyodide = await initPyodide;
/*pyodide.toPy(v1);*/

pyodide.runPython(`

from js import stands
from js import nvents

stands = stands.to_py()

for i in range(nvents):
	n.setVentPosition(i, float(stands[i]))    
	
n.update()
flows = n.getFlows()
dp = n.getPressureDrop()
`
);

jsFlows = pyodide.globals.get("flows").toJs();
pressureDrop = pyodide.globals.get("dp").toFixed(1);
updateDisplay(jsFlows,pressureDrop,stands);

}


function drawNetwork(n){

	var margin = 10
	var WD = 60;

	if (n<=7){
		var pictureWidth = 500;
		}
	else{
		var pictureWidth = n*(WD+20)+2*margin;
	}

	var WT = pictureWidth-2*margin;
	var DELTA = (WT - n*WD)/(n-1); 

	var H1=100;
	var H2=H1+WD;
	var H3=H2+2*WD;
	
	
	H3p = H3-H2

	svgString="M "+margin+" "+(H3+margin)
	
	svgString+="v -"+H2+" h "+(WT-WD)/2+" v -"+ H3p +" h "+WD+" v "+H3p+" h "+(WT-WD)/2+" v "+H2

	for (let i=0;i<n-1;i++){
		svgString += " h -"+WD
		svgString += " v -"+H1
		svgString += " h -"+DELTA
		svgString += " v "+H1
	}
	svgString += "Z"

	//svgString+="v "+H2+" h "+WT+" v -"+H2
	
	
	deleteClassElements('network-svg')
	
	var draw = SVG().addTo('.networkdiv').size(pictureWidth, 300)
	draw.addClass('network-svg')
	var path = draw.path(svgString)

	path.fill('none').stroke({width:4, color: 'black'})

	return DELTA

}

function drawArrow(xcenter,ypos){
	
	var margin=0;
	var W = 10;
	var L = 45 ;

	xpos = xcenter - W-margin
	
	svgString="M "+(margin+W/2+xpos)+" "+(margin+ypos);
	svgString += " h "+W;
	svgString += " v "+L;
	svgString += " h "+1/2*W;
	svgString += " l -"+W+" "+L/4;
	svgString += " l -"+W+" -"+L/4;
	svgString += " h "+1/2*W;
	svgString += " z";
	
	draw = SVG.find('.network-svg');
	
	var path = draw.path(svgString)

	path.fill({color:'#008080'}).stroke({width:1, color: 'black'})
	
}

function drawNetworkArrows(n){

	margin=10
	WD = 60
	if (n<=7){
		var pictureWidth = 500;
	}
	else{
		var pictureWidth = n*(WD+20)+2*margin;
	}
	var WT = pictureWidth-2*margin;
	var DELTA = (WT - n*WD)/(n-1); 

	
	for (let i=0;i<n;i++){
		
		xcenter = margin + WD/2 + i*(WD+DELTA)
		drawArrow(xcenter,210)
	}
}


function createInput(number,marginRight,totalNumberOfVents){

	inputForm = document.getElementsByClassName('form-inline')[0]

	var inputElement = document.createElement('input');
	inputElement.id = 'flow'+number+'input';

    inputElement.type = 'range';
    inputElement.className = 'counter';
	
	inputElement.style = "width:"+60+"px;margin-left:0;margin-right:"+marginRight+"px";
	
	if (number==1){
		inputElement.style = "width:60px;margin-left:10;margin-right:"+marginRight+"px";
	}	
	
	inputForm.appendChild(inputElement);
	inputElement.setAttribute("value", "100");
	inputElement.setAttribute("min", "1");
	inputElement.setAttribute("max", "100");

	inputElement.onchange = function(){update(totalNumberOfVents);};

}

function createFlowDisplay(number,width,marginRight){

	horizontal = document.getElementsByClassName('horizontal')[0];
	var inputElement = document.createElement('p');

	inputElement.id = 'flow'+number+'display';
	inputElement.className = 'flowdisplay';

	horizontal.appendChild(inputElement);


	inputElement.style = "width:"+width+"px;margin-left:0;margin-right:"+marginRight+"px";
	if (number==1){
		inputElement.style = "width:60px;margin-left:10;margin-right:"+marginRight+"px";
	}	
	
	inputElement.innerHTML  = "0 m³/h";
	
}


function createNetWorkInputs(n,spacing){

	for (let i=0;i<n;i++){

		createInput(i+1,spacing,n);
		createFlowDisplay(i+1,60,spacing);
	}
}




function initialize(numberOfDucts){


	console.log("type")
	console.log(typeof numberOfDucts)

	deleteClassElements('network-svg')
	deleteClassElements('counter')
	deleteClassElements('flowdisplay')

	spaceBetweenDucts = drawNetwork(numberOfDucts)
	drawNetworkArrows(numberOfDucts)
	createNetWorkInputs(numberOfDucts,spaceBetweenDucts)
	main(numberOfDucts)

}

async function changeFlow(flowValue){

	let pyodide = await initPyodide;

	window.newFlowValue = flowValue;

	console.log(flowValue);
	

	pyodide.runPython(`

from js import newFlowValue
n.changeTotalFlowRate(newFlowValue)
flows = n.getFlows()
dp = n.getPressureDrop()
`
);

jsFlows = pyodide.globals.get("flows").toJs();
pressureDrop = pyodide.globals.get("dp").toFixed(1);
updateDisplay(jsFlows,pressureDrop,stands);

}



initialize(6)





</script>
</body>
</html>
